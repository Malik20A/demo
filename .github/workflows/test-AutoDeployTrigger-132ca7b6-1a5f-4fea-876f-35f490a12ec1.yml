env:
  repo: "https://github.com/Malik20A/demo"
  app_version: "5.0.0"
  app_name: "demo"

name: Trigger auto deployment for test

# When this action will be executed
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allow mannually trigger
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v3

      - name: Clone a repo
        run: |
          git clone ${{ env.repo }}

      - name: Switch Branch
        working-directory: ${{ env.app_name }}
        run: |
          git checkout ${{ env.app_version }}


      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.TEST_AZURE_CREDENTIALS }}

      - name: Build and push container image to registry
        uses: azure/container-apps-deploy-action@v1
        with:
          appSourcePath: ${{ github.workspace }}
          registryUrl: hussdemo.azurecr.io
          registryUsername: ${{ secrets.TEST_REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.TEST_REGISTRY_PASSWORD }}
          containerAppName: test
          resourceGroup: hussdemo
          imageToBuild: hussdemo.azurecr.io/test:${{ github.sha }}
